<div class="wrapper">
  <section class="project-details">
    <header>
      <h2>{{ project()?.name }}</h2>
    </header>
    <div class="project-description">
      <ul>
        <li>{{ 'dashboard.totalObjects' | translate }}: {{ project()?.objects?.length }}</li>
        @if(project()?.address?.postal_code) {
          <li>{{ project()?.address?.postal_code }}</li>
        }
        <li>{{ project()?.address?.street }}</li>
        @if (project()?.address?.house_number) {
          <li>{{ project()?.address?.house_number }}</li>
        }
        @if (project()?.address?.level) {
          <li>{{ 'project.level' | translate }}: {{ project()?.address?.level }}</li>
        }
        @if (project()?.address?.door_number) {
          <li>{{ 'project.doorNumber' | translate }}: {{ project()?.address?.door_number }}</li>
        }
        <li>
          <p>{{ project()?.note }}</p>
        </li>
      </ul>
      <button
        type="button"
        class="group-edit-toggle button button-primary"
        (click)="startEditingProject()"
        aria-label="Edit message"
      >
        ✎
      </button>
    </div>
  </section>

  @if (project()?.archived_at && project()?.archive_comment) {
    <section class="archive-comment-section">
      <h3>{{ 'projects.archiveComment' | translate }}</h3>
      <p class="archive-comment">{{ project()?.archive_comment }}</p>
    </section>
  }

  <section class="project-category-section">
    <div class="category-selector">
      <label for="projectCategory">{{ 'projects.category' | translate }}</label>
      <select
        id="projectCategory"
        [value]="project()?.category"
        [disabled]="updatingCategory()"
        (change)="updateCategory($any($event.target).value)"
        class="category-select"
      >
        <option value="">{{ 'objects.noCategory' | translate }}</option>
        @for (category of project()?.categories; track category) {
          <option [value]="category" [selected]="category === project()?.category">
            {{ category }}
          </option>
        }
      </select>
    </div>
  </section>

  <app-filter [filter]="filterData()" (filterChange)="filterChanged($event)"></app-filter>

  @if (!project()?.archived_at) {
    <div class="action-buttons">
      <button type="button" class="button button-primary" (click)="manageCategories()">
        {{ 'projects.manageCategories' | translate }}
      </button>
      <button type="button" class="button button-primary" (click)="generateProtocol()">
        {{ 'protocols.generateProtocol' | translate }}
      </button>
      <button type="button" class="button button-primary" (click)="toggleArchiveProject(true)">
        {{ 'projects.archiveProject' | translate }}
      </button>
    </div>
  } @else {
    <div class="action-buttons">
      <button type="button" class="button button-primary" (click)="toggleArchiveProject(false)">
        {{ 'projects.unarchiveProject' | translate }}
      </button>
    </div>
  }
  <div class="content-wrapper">
    @if (filteredObjects().length > 0) {
      <div class="card-wrapper">
        @for (object of filteredObjects(); track object._id?.$oid) {
          <div class="card" [routerLink]="'/objects/tab/' + object._id?.$oid">
            <app-status-pill [status]="object?.status || 'created'" />
            <h2 class="headline">
              {{ object.address.street }} {{ object.address.house_number }}
              {{ object.address.house_number && object.address.door_number ? '/' : null }}
              {{ object.address.door_number }}
            </h2>
            @if (object.note) {
              <p class="note">{{ object.note }}</p>
            }
            @if (object.category) {
              <div class="category">{{ object.category }}</div>
            }
            <div class="created-at">{{ object.created_at | date: 'dd.MM.yyyy' }}</div>
          </div>
        }
      </div>
    }
    @if (project()) {
      <section class="protocols-section">
        <div>
          <div class="section-header">
            <h3>{{ 'protocols.generatedProtocols' | translate }}</h3>
          </div>
          @if (projectProtocols().length > 0) {
            <div class="protocol-list">
              @for (protocol of projectProtocols(); track protocol._id.$oid) {
                <div class="protocol-item">
                  <div class="protocol-info">
                    <p class="protocol-name">{{ protocol.template_name }}</p>
                    <p class="protocol-meta">
                      <span>{{ protocolDescription(protocol) }}</span>
                      <span class="separator">•</span>
                      <span>{{ protocolGeneratedAt(protocol) }}</span>
                    </p>
                  </div>
                  <button
                    type="button"
                    class="button button-secondary"
                    (click)="downloadProtocol(protocol)"
                  >
                    {{ 'protocols.download' | translate }}
                  </button>
                </div>
              }
            </div>
          } @else {
            <p class="empty-state">{{ 'protocols.noProtocolsYet' | translate }}</p>
          }
        </div>
      </section>
    }
    @if (files()) {
      <app-file-list
        [files]="files()"
        (fileDeleted)="onFileDeleted()"
        (metadataUpdated)="onFileDeleted()"
      ></app-file-list>
    }
  </div>

  <!-- /* Floating icons */ -->
  <label class="icon upload-icon floating-icon" for="file">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
      <!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
      <path
        d="M352 173.3L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 173.3L246.6 214.7C234.1 227.2 213.8 227.2 201.3 214.7C188.8 202.2 188.8 181.9 201.3 169.4L297.3 73.4C309.8 60.9 330.1 60.9 342.6 73.4L438.6 169.4C451.1 181.9 451.1 202.2 438.6 214.7C426.1 227.2 405.8 227.2 393.3 214.7L352 173.3zM320 464C364.2 464 400 428.2 400 384L480 384C515.3 384 544 412.7 544 448L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 448C96 412.7 124.7 384 160 384L240 384C240 428.2 275.8 464 320 464zM464 488C477.3 488 488 477.3 488 464C488 450.7 477.3 440 464 440C450.7 440 440 450.7 440 464C440 477.3 450.7 488 464 488z"
      />
    </svg>
  </label>
  <input
    type="file"
    name="file"
    id="file"
    accept="image/*"
    (change)="onFileSelected($event)"
    [disabled]="uploading()"
    #fileInput
  />

  <button
    type="button"
    class="add-icon floating-icon"
    (click)="addObject()"
    [tabIndex]="2"
    [attr.aria-label]="'objects.add' | translate"
  >
    <i class="add" role="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <path
          stroke="white"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 5v14m-7-7h14"
        />
      </svg>
    </i>
  </button>
</div>
